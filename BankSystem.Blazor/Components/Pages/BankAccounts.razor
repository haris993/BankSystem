@page "/bank-accounts"
@rendermode InteractiveServer
@using BankSystem.Blazor.Components.Shared
@using BankSystem.Blazor.Models
@inject BankSystem.Blazor.Services.BankAccountApiService Api

<h3 class="text-center mt-5 mb-5">Racuni klijenata</h3>

<div class="row mb-5">
    <div class="col-md-3">
        <input class="form-control" type="search" placeholder="Search..." value="@Search" @oninput="OnSearchChanged" />
    </div>
    <div class="col-md-2">
        <select class="form-select" @onchange="@OnCurrencyChanged" value="@SelectedCurrency">
            <option value="">All Currencies</option>
            @foreach (var cur in Currencies)
            {
                <option value="@cur">@cur</option>
            }
        </select>
    </div>
    <div class="col-md-2">
        <select class="form-select" @onchange="@OnStatusChanged" value="@SelectedStatus">
            <option value="">All Status</option>
            <option value="true">Active</option>
            <option value="false">Inactive</option>
        </select>
    </div>
</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Account</th>
            <th>Client</th>
            <th>Balance</th>
            <th>Currency</th>
            <th>Type</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody>
        @if (Accounts?.Items != null && Accounts.Items.Any())
        {
            @foreach (var acc in Accounts.Items)
            {
                <tr>
                    <td>@acc.AccountNumber</td>
                    <td>@acc.ClientName</td>
                    <td>@acc.Balance.ToString("N2")</td>
                    <td>@acc.Currency</td>
                    <td>@acc.AccountType</td>
                    <td>
                        @if (acc.IsActive)
                        {
                            <span class="badge bg-success">Active</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Inactive</span>
                        }
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="6" class="text-center">No accounts found.</td></tr>
        }
    </tbody>
</table>

<Pagination CurrentPage="Page"
            PageSize="PageSize"
            TotalCount="Accounts?.TotalCount ?? 0"
            OnPageChanged="@OnPageChanged"
            OnPageSizeChanged="@OnPageSizeChanged" />

@code {
    private PagedResult<BankAccountViewModel> Accounts = new();
    private int Page = 1;
    private int PageSize = 10;

    private List<string> Currencies { get; set; } = new();

    private string? Search { get; set; }
    private string? SelectedCurrency { get; set; }
    private string? SelectedStatus { get; set; }
    private System.Timers.Timer? debounceTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync(Page);
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        Search = e.Value?.ToString();
        debounceTimer?.Stop();
        debounceTimer?.Dispose();

        debounceTimer = new System.Timers.Timer(3000); 
        debounceTimer.Elapsed += async (s, args) =>
        {
            debounceTimer.Stop();
            debounceTimer.Dispose();
            debounceTimer = null;

            await InvokeAsync(async () =>
            {
                await LoadDataAsync(1);
                StateHasChanged();
            });
        };
        debounceTimer.Start();
    }

    private async Task OnCurrencyChanged(ChangeEventArgs e)
    {
        SelectedCurrency = e.Value?.ToString();
        await LoadDataAsync(1);
    }

    private async Task OnStatusChanged(ChangeEventArgs e)
    {
        SelectedStatus = e.Value?.ToString();
        await LoadDataAsync(1);
    }

    private async Task OnPageChanged(int newPage)
    {
        Console.WriteLine($"[BankAccounts] OnPageChanged -> {newPage}");
        await LoadDataAsync(newPage);
    }

    private async Task OnPageSizeChanged(int newPageSize)
    {
        Console.WriteLine($"[BankAccounts] OnPageSizeChanged -> {newPageSize}");
        PageSize = newPageSize;
        await LoadDataAsync(1);
    }

    private async Task LoadDataAsync(int page)
    {
        Page = Math.Max(1, page);

        bool? isActive = SelectedStatus switch
        {
            "true" => true,
            "false" => false,
            _ => null
        };

        Console.WriteLine($"[BankAccounts] Loading page={Page} pageSize={PageSize} currency='{SelectedCurrency}' isActive={isActive} search='{Search}'");

        try
        {
            Accounts = await Api.GetBankAccountsAsync(
                page: Page,
                pageSize: PageSize,
                currency: SelectedCurrency,
                isActive: isActive,
                search: Search);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[BankAccounts] LoadDataAsync exception: {ex.Message}");
            Accounts = new PagedResult<BankAccountViewModel>();
        }

        // Update currencies list for dropdown
        Currencies = Accounts.Items?.Select(a => a.Currency)
            .Where(c => !string.IsNullOrEmpty(c))
            .Distinct()
            .OrderBy(c => c)
            .ToList() ?? new List<string>();

        StateHasChanged();
    }
}
